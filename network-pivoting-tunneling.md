# Network Pivoting through Tunneling and Port Forwarding

## Native OS

### Linux

**Using Iptables**

```
# First check if ip forwarding is enabled(1) in kernel
cat /proc/sys/net/ipv4/ip_forward
OR
sysctl net.ipv4.ip_forward

# If 0, enable(1) with
sysctl -w net.ipv4.ip_forward=1
```

```
# Forward a local port to another address/port pair.
iptables -t nat -A PREROUTING -p tcp --dport LOCAL_PORT -j DNAT --to-destination TARGET_IP:PORT

# Forward a range of ports to another address
iptables -t nat -A PREROUTING -p tcp --dport 8000:8100 -j DNAT --to-destination TARGET_IP

# List forwardings
iptables -t nat -L PREROUTING --line-number -v

# Remove a forwarding
iptables -t nat -D PREROUTING LINE_NUMBER
```

### Windows

**Using netsh**

Usually requiring SYSTEM or not having to worry about UAC.

```
# Local port forwarding
netsh interface portproxy add v4tov4 listenport=LOCAL_PORT listenaddress=LOCAL_IP connectport=TARGET_PORT connectaddress=TARGET_IP

# High random port numbers will probably not be allowed by Windows firewall, create a rule to let them in
netsh advfirewall firewall add rule name="Allow my port" protocol=TCP dir=in localip=LOCAL_IP localport=LOCAL_PORT action=allow
```

## Using SSH

If SSH is enabled and 'TcpPortForwarding' allowed, it's easy and quick to setup port forwarding tunnels, you just have to choose the right method to your needs. If you have a SSH client and no active server/daemon, reverse is probably the way to go.

Useful SSH client options:

```
# Run as background job
-f

# Do not send any remote commands
-N
```

You can use several '-L' or '-R' options in the same tunnel to make several port forwards.

**Local Port Forwarding**

*Make my local port of choice point to this target and port, that is accessible on the other end of this tunnel(server end of tunnel).*

- This might be the case if you have SSH access **to** your target or pivoting point.

```
ssh -L LOCAL_PORT:TARGET_IP:TARGET_PORT USER@TUNNEL_TARGET
ssh -L 8080:localhost:80 user@192.168.1.1
ssh -L 8080:80 user@192.168.1.1
ssh -L 8080:intraserver.com:443 user@gatewayserver.com
```

**Remote Port Forwarding**

*Make this port on the server I'm connecting to, point to this target and port that it can access through the tunnel I'm creating(client end of tunnel).*

- This might be the case if you can connect **from** your target/pivoting point back to your host/attack server.

```
ssh -R SERVER_PORT:TARGET_IP:TARGET_PORT USER@SERVER_IP
ssh -R 8080:localhost:80 kali@kali.com
ssh -R 8080:intraserver.com:80 kali@kali.com
```

If your doing this from target you your attacker machine, you should add an option to not save your host key: `UserKnownHostsFile=/dev/null` in linux.

If you don't have a fully interactive shell, you can disable host key checking to prevent the interactive prompt: `StrictHostKeyChecking=no`.

If doing a passwordless login from the target machine, add the targets pubkey to your authorized_keys file, but restrict it:

```
from="TARGET_IP",no-agent-forwarding,no-X11-forwarding,no-pty ssh-rsa PUBKEY
```

**Dynamic Port Forwarding(SOCKS Proxy)**

- Local: *Start a SOCKS proxy server on this local port and tunnel all traffic to that port through this tunnel*
- Remote/reverse: *Make this port on the server I'm connecting to, act as a SOCKS proxy back to my(client-side) network.*

```
# Local
ssh -D 9050 user@target.com

# Remote
ssh -R 9050 kali@kali.com
```

The remote option is available since SSH 7.6 client. If this is not available, start a local SOCKS proxy and then point a remote port forward to the proxy port.

**TUN/TAP**

*"Poor mans VPN"*

```
```

**X tunneling**

```
```

# To do list

## Proxychains

## Plink

## Rinetd

## Hiding by tunneling over other protocols